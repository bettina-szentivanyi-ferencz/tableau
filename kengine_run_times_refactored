
DROP VIEW IF EXISTS sandbox.kengine_run_times_refactored;
CREATE VIEW sandbox.kengine_run_times_refactored AS

select distinct 
	factory_eventsink.timestamp,
	factory_eventsink.project_name,
	factory_eventsink.session_uid,
	factory_eventsink.scene_uid,
	factory_eventsink.processing_time,
	factory_eventsink.event_name,
	JSON_EXTRACT_SCALAR(mongodb_projects_project. _json_data,"$.is_using_flow_management") is_using_flow_management,
from
	`thelake.factory_eventsink` factory_eventsink --original table:`raw.eventsink_byday`
join `thelake.mongodb_projects_project` mongodb_projects_project on factory_eventsink.project_name = p.project_name --original table:`dwh_mongodb.projects_project`
where
	factory_eventsink.timestamp >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(),interval 14 day)
	and efactory_eventsink.event_name in 
  ("RECALCULATION_ENDED",
"RECALCULATION_ENDED_LIVE",
"SCENE_CALCULATED",
"SCENE_CALCULATED-LIVE",
"SCENE_CALCULATED_LIVE",
"SCENE_OFFLINE-CALCULATED",
"SESSION_CALCULATED",
"SESSION_CALCULATED-LIVE",
"SESSION_CALCULATED-LIVE_LIVE",
"SESSION_CALCULATED_LIVE",
"SESSION_COMPLETED-LIVE"
);
